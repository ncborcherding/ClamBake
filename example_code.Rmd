---
title: "Untitled"
output: html_document
---

```{r}
source("~/Documents/GitHub/ClamBake/R/load.data.R")
source("~/Documents/GitHub/ClamBake/R/merge.data.R")
source("~/Documents/GitHub/ClamBake/R/utils.R")

dir.to.use <- "./data_sets/2022-03-14 B6 Fed Fasting 30C Metabolic Data/cage_data/2022-03-14 D1 Feed"
meta.file <- "./data_sets/2022-03-14 B6 Fed Fasting 30C Metabolic Data/feed.meta.csv"

dat.fed <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 equilibrate.interval = 8,
                 contrast = "Condition",
                      baseline = "Pre")

dir.to.use <- "./data_sets/2022-03-14 B6 Fed Fasting 30C Metabolic Data/cage_data/2022-03-15 D2 Fasting"
meta.file <- "./data_sets/2022-03-14 B6 Fed Fasting 30C Metabolic Data/fast.meta.csv"

dat.fast <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 contrast = "Condition",
                      baseline = "Pre")

dir.to.use <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/cage_data/2022-03-22 30C"
meta.file <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/30.meta.csv"

dat.30 <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 contrast = "Condition",
                      baseline = "Pre")

dir.to.use <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/cage_data/2022-03-23 25C"
meta.file <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/25.meta.csv"

dat.25 <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 contrast = "Condition",
                      baseline = "Pre")

dir.to.use <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/cage_data/2022-03-24 20C"
meta.file <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/20.meta.csv"

dat.20 <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 contrast = "Condition",
                      baseline = "Pre")

dir.to.use <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/cage_data/2022-03-25 15C"
meta.file <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/15.meta.csv"

dat.15 <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 contrast = "Condition",
                      baseline = "Pre")

dir.to.use <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/cage_data/2022-03-26 10C"
meta.file <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/10.meta.csv"

dat.10 <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 contrast = "Condition",
                      baseline = "Pre")

dir.to.use <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/cage_data/2022-03-27 5C"
meta.file <- "./data_sets/2022-03-22 B6 Temp Decline Metabolic Data/5.meta.csv"

dat.5 <- load.data(file.dir = dir.to.use,
                 meta.file = meta.file, 
                 contrast = "Condition",
                      baseline = "Pre")
  

full.data <- merge.data(list(dat.fed,dat.fast,dat.30,dat.25,dat.25,dat.20,dat.15,dat.10,dat.5))
```

```{r}
cage.data <- full.data
y.axis = "VO2"
plot.track <- function(cage.data, 
                       group.by = NULL,
                       split.by = NULL,
                       y.axis = NULL,
                       sample.subset = NULL) {
  
  laaply
  pre.plot.dat <- bind_rows(cage.data[[1]])
  colnames(pre.plot.dat)[which(colnames(pre.plot.dat) == y.axis)] <- "y.axis"
  
  if(!is.null(group.by) | !is.null(split.by)) {
    pre.plot.dat <- pull.dat(c(group.by, split.by), cage.data)
  } else {
    pre.plot.dat <- bind_rows(cage.data[[1]])
    pre.plot.dat <- pre.plot.dat %>%
      group_by(Interval_num) %>%
      summarise(y.axis = mean(y.axis))
    colnames(pre.plot) <- c("x.axis","y.axis")

  if(is.null(group.by)) {
    plot <- ggplot(pre.plot, aes(x=as.numeric(x.axis), y = y.axis)) + 
                  stat_smooth(
                      geom = 'area', method = 'gam', span = 1/3, fill = "grey") + 
      ylab(y.axis) + 
      xlab("Time Interval") + 
      theme_classic()
  } else {
      plot <- ggplot(pre.plot, aes(x=as.numeric(x.axis), y = y.axis)) + 
                  stat_smooth(
                      geom = 'area', method = 'gam', span = 1/3,
                      aes(fill = group)) + 
      ylab(y.axis) + 
      xlab("Time Interval") + 
      theme_classic()
  }
  if(!is.null(split.by)) {
    plot <- plot + facet_grid(.~split)
  }
  
  return(plot)
}

pull.dat <- function(header.list, original.dat) {
  meta <- original.dat[[2]]
  for(i in seq_along(original.dat[[1]])) {
    list.tmp.it <- original.dat[[1]][[i]]
    for(j in seq_along(header.list)) {
      list.tmp.it[,header.list[j]] <- unique(meta[which(meta$filename == names(original.dat[[1]])[i]), header.list[j]])
    }
  if(i == 1) {
    out.data <- list.tmp.it 
  } else {}
    out.data <- rbind(out.data, list.tmp.it)
  }
  return(out.data)
}
```

